#!/bin/bash
# Assumes that EnterMedia has been installed in /usr/share/entermediadb
# Should we have a config file?
COMMAND=$1
ENTERMEDIADB_HOME=/usr/share/entermediadb
DEFAULT_PORT=8080
DEFAULT_DATA=/media/data
DEFAULT_ROOT=/opt/entermediadb

function valid_port() {

	if [[ -z "$1" ]]; then
		# just make sure nobody uses a port that requires root or is generally used by system
		# maybe do something else here to prevent duplicates
		echo "$1 is a reserved port. Please choose a value larger than 1025"
		exit 0
	fi

}

function confirm() {

	echo "$1"
	read -r -p "Continue? [y/N] " response
	case $response in
    	[yY]) 
        	return 1
        	;;
    	*)
        	echo Cancelling...
		exit
        	;;
	esac
}

function deploy() {
	
	# Go somewhere that exists to prevent getcwd errors
	[[ ! -d `pwd` ]] && cd /

	local ENDPOINT=$1
	local DATA=$2
	local PORT=$3
	

	valid_port $PORT

	local PROMPT="This will set up EntermediaDB at $ENDPOINT with data at $DATA and tomcat on port $PORT."
	confirm "$PROMPT"
	local CONFIRMED=$?
	if [[ $CONFIRMED != 1 ]]; then
		echo Cancelling...
		exit
	fi

	if [[ ! -d "$ENTERMEDIADB_HOME" ]]; then
		# Meaningless to deploy without Entermedia
		echo Entermedia NOT FOUND at $ENTERMEDIADB_HOME! Cannot proceed.
		exit
	fi

	if [[ ! -d "$ENDPOINT" ]]; then
		mkdir -p $ENDPOINT
	fi
	if [[ -z `getent passwd entermedia` ]]; then
		# Just in case we are deploying where EMDB is on a network mount
		echo Creating entermedia user...
		adduser entermedia
	fi
	# make links and copy stuff
	mkdir -p $ENDPOINT/tomcat/{logs,temp} && cp -rp $ENTERMEDIADB_HOME/tomcat/conf $ENDPOINT/tomcat && cp -rp $ENTERMEDIADB_HOME/tomcat/bin $ENDPOINT/tomcat
	sed "s/%PORT%/$PORT/g" <$ENTERMEDIADB_HOME/tomcat/conf/server.xml.template >$ENDPOINT/tomcat/conf/server.xml
	mkdir -p $ENDPOINT/webapp/{WEB-INF,media}
	cp $ENTERMEDIADB_HOME/webapp/media/_site.xconf $ENDPOINT/webapp/media
	cp $ENTERMEDIADB_HOME/webapp/* $ENDPOINT/webapp 2> /dev/null

	cp -r $ENTERMEDIADB_HOME/webapp/theme $ENDPOINT/webapp/
	cp $ENTERMEDIADB_HOME/webapp/WEB-INF/web.xml $ENDPOINT/webapp/WEB-INF/
	cp -r $ENTERMEDIADB_HOME/webapp/WEB-INF/{bin,base,lib} $ENDPOINT/webapp/WEB-INF/
	if [[ ! -d "$DATA" ]]; then
	      mkdir -p $DATA
              cp -rp $ENTERMEDIADB_HOME/webapp/WEB-INF/data/* $DATA 
	fi
	ln -s $DATA $ENDPOINT/webapp/WEB-INF/data
	chown -R entermedia. $ENDPOINT
	chown -R entermedia. $DATA
	cd $ENDPOINT/tomcat/bin
	# add proper home to local tomcat
	echo "export CATALINA_BASE=\"$ENDPOINT/tomcat\"" >> $ENDPOINT/tomcat/bin/setenv.sh
	su entermedia -c "$ENDPOINT/tomcat/bin/startup.sh"
}

case $COMMAND in
'install')
	#gather info, confirm, and deploy
	echo "Where do you want to install to? (default: /opt/entermediadb)"
	read WHERE
	echo "Where will the data be located? (default: /media/data)"
	read DATA
	echo "What port do you want tomcat to listen on? (default: 8080)"
	read PORT

  	# Make sure defaults are set if nothing given
        [[ -z "$WHERE" ]] && WHERE=$DEFAULT_ROOT
        [[ -z "$DATA" ]] && DATA=$DEFAULT_DATA
        [[ -z "$PORT" ]] && PORT=$DEFAULT_PORT

	deploy $WHERE $DATA $PORT
	;;
'delete')
	local WHERE=$2
	if [[ ! -d "$WHERE" ]]; then
		echo $WHERE is not a valid directory!
		exit 0
	fi
	cd $WHERE/tomcat/bin
	confirm "Are you sure you want to delete the $WHERE installation?"
	./shutdown.sh
	# stop running tomcat
	rm -rf $WHERE
	echo Deleted EntermediaDB from $WHERE.
	;;
'update')
	local WHERE=$2
	if [[ ! -d "$WHERE" ]]; then
		echo $WHERE is not a valid directory!
		exit 0
	fi
	confirm "Are you sure you want to update the $WHERE installation?"
	rm -rf $WHERE/webapp/WEB-INF/{base,lib,bin}
	echo Copying new files to WEB-INF ...
	cp -r $ENTERMEDIADB_HOME/webapp/WEB-INF/{bin,base,lib} $WHERE/webapp/WEB-INF/
	rm -f $WHERE/webapp/WEB-INF/web.xml
	echo Updating web.xml ...
	cp $ENTERMEDIADB_HOME/webapp/WEB-INF/web.xml $WHERE/webapp/WEB-INF/
*)
	echo "Usage: entermedidb install | entermediadb delete /opt/entermediadb";
	exit 0;
	;;
esac

