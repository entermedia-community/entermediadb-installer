#!/bin/bash
# Variables CLIENT_NAME and INSTANCE_PORT should be coming from Docker ENV
	if [[ ! -d /opt/entermediadb/webapp/WEB-INF ]]; do
	  cp -rp /usr/share/entermediadb/webapp /opt/entermediadb/
	fi
	if [[ ! -d /opt/entermediadb/tomcat/conf ]]; do
	  # make links and copy stuff
          mkdir -p "/opt/entermediadb/tomcat"/{logs,temp}
          cp -rp "/usr/share/entermediadb/tomcat/conf" "/opt/entermediadb/tomcat"
          cp -rp "/usr/share/entermediadb/tomcat/bin" "/opt/entermediadb/tomcat"
	  echo "export CATALINA_BASE=\"/opt/entermediadb/tomcat\"" >> "/opt/entermediadb/tomcat/bin/setenv.sh"
	  sed "s/%PORT%/${INSTANCE_PORT}/g;s/%NODE_ID%/${CLIENT_NAME}${PORT}/g" <"/usr/share/entermediadb/tomcat/conf/server.xml.cluster" >"/opt/entermediadb/tomcat/conf/server.xml"
	  sed "s/%CLUSTER_NAME%/${CLIENT_NAME}-cluster/g" <"/usr/share/entermediadb/conf/node.xml.cluster" >"/opt/entermediadb/webapp/WEB-INF/node.xml"
          chmod 755 "/opt/entermediadb/tomcat/bin/tomcat"
	fi

        echo Starting EnterMedia ...
	/opt/entermediadb/tomcat/bin/catalina.sh run 
